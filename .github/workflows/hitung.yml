# .github/workflows/count-report-badge-artikel.yml

name: Hitung & Lapor File Artikel dan Gambar

on:
  schedule:
    # Setiap hari pukul 05:00 WITA (UTC+8) â†’ 21:00 UTC hari sebelumnya
    - cron: '0 21 * * *'
  workflow_dispatch: # Ditambahkan agar bisa dijalankan manual

jobs:
  count_and_report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Variables
        id: vars
        run: |
          # === MODIFIKASI: Target sekarang adalah dua folder ===
          TARGETS="artikel img"
          DATE=$(date +'%m-%d')
          # Laporan akan diberi nama generik karena targetnya > 1
          REPORT="mini/${DATE}-laporan_konten.txt"
          
          echo "report_path=$REPORT" >> $GITHUB_OUTPUT
          echo "targets=$TARGETS"      >> $GITHUB_OUTPUT
          echo "date=$DATE"          >> $GITHUB_OUTPUT

      - name: Count Files by Extension
        id: counts
        run: |
          TARGETS="${{ steps.vars.outputs.targets }}"
          declare -A counts
          
          # Loop untuk menghitung ekstensi spesifik di kedua folder
          for ext in html jpg png; do
            counts[$ext]=$(find $TARGETS -maxdepth 1 -type f -iname "*.$ext" | wc -l)
          done
          
          # Hitung total semua file di kedua folder
          counts[all]=$(find $TARGETS -maxdepth 1 -type f | wc -l)
          
          for key in "${!counts[@]}"; do
            echo "$key=${counts[$key]}" >> $GITHUB_OUTPUT
          done

      - name: Generate Report
        run: |
          REPORT="${{ steps.vars.outputs.report_path }}"
          DATE="${{ steps.vars.outputs.date }}"
          TARGETS="${{ steps.vars.outputs.targets }}"
          
          # Prefix khusus untuk folder artikel
          PREFIX_ARTIKEL="https://frijal.pages.dev/artikel/"
          
          mkdir -p "$(dirname "$REPORT")"
          {
            echo "LAPORAN KONTEN: artikel & img ($DATE)"
            echo "================================="
            echo "Total File: ${{ steps.counts.outputs.all }}"
            echo "HTML=${{ steps.counts.outputs.html }}, JPG=${{ steps.counts.outputs.jpg }}, PNG=${{ steps.counts.outputs.png }}"
            echo ""
            echo "Ringkasan per ekstensi (di semua folder):"
            find $TARGETS -maxdepth 1 -type f -print \
              | sed 's/.*\.//' \
              | sort \
              | uniq -c \
              | sort -nr
            echo ""
            echo "URL File HTML (dari folder 'artikel'):"
            find "artikel" -maxdepth 1 -type f -iname "*.html" \
              | sed "s|^artikel/|$PREFIX_ARTIKEL|g" \
              | sort
          } > "$REPORT"
          
          echo "Laporan berhasil dibuat:"
          cat "$REPORT"

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Buat Badge JSON
        # Tidak perlu modifikasi di sini, karena sudah menggunakan output dari langkah 'counts'
        run: |
          mkdir -p ext
          html=${{ steps.counts.outputs.html }}
          jpg=${{ steps.counts.outputs.jpg }}
          color=$(if (( html > jpg )); then echo red; elif (( html < jpg )); then echo green; else echo blue; fi)

          jq -n --arg m "$html" \
            '{schemaVersion:1, label:"artikel", message:$m, color:"blue"}' \
            > ext/html_count_badge.json

          jq -n --arg m "$jpg" \
            '{schemaVersion:1, label:"cover", message:$m, color:"green"}' \
            > ext/jpg_count_badge.json

          jq -n --arg mh "$html" --arg mj "$jpg" --arg c "$color" \
            '{schemaVersion:1, label:"html/jpg", message:("\($mh) / \($mj)"), color:$c}' \
            > ext/html_jpg_badge.json

      - name: Rotate Reports
        # Tidak perlu modifikasi, logika pembersihan tetap sama
        run: |
          mkdir -p mini
          mapfile -t files < <(ls -1t mini/*-laporan_*.txt 2>/dev/null)
          if ((${#files[@]} > 7)); then
            printf '%s\n' "${files[@]:7}" | xargs rm -f
          fi

      - name: Commit Jika Ada Perubahan
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: >
            chore: update laporan & badge untuk artikel dan img
          branch: ${{ github.ref_name }}
          file_pattern: |
            mini/*
            ext/*
          skip_empty_commit: true
