name: âœ‚ï¸ Bersihkan Sebelum & Setelah HTML

on:
  workflow_dispatch:
    inputs:
      target_folder:
        description: "Folder target (misalnya: artikel)"
        required: true
        default: "artikel"

permissions:
  contents: write
  pull-requests: write

jobs:
  clean-html-edges:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout kode
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âœ‚ï¸ Bersihkan konten sebelum <!DOCTYPE html> dan setelah </html>
        id: clean
        run: |
          TARGET="${{ github.event.inputs.target_folder }}"
          echo "ğŸ§¹ Memproses semua file HTML di folder: $TARGET"
          TOTAL_REMOVED=0
          FILE_COUNT=0

          find "$TARGET" -type f -name "*.html" | while read -r file; do
            ((FILE_COUNT++))
            echo "ğŸ”§ Membersihkan: $file"

            TOTAL_BEFORE=$(wc -l < "$file")

            # Ambil hanya dari <!DOCTYPE html> hingga </html> (case-insensitive)
            awk 'BEGIN{IGNORECASE=1}
                 /<!DOCTYPE[[:space:]]+html>/,/<\/html>/ {print}
                 /<\/html>/ {exit}' "$file" > "$file.tmp"

            TOTAL_AFTER=$(wc -l < "$file.tmp")
            REMOVED=$((TOTAL_BEFORE - TOTAL_AFTER))
            TOTAL_REMOVED=$((TOTAL_REMOVED + (REMOVED > 0 ? REMOVED : 0)))

            if (( REMOVED > 0 )); then
              mv "$file.tmp" "$file"
              echo "âœ… $REMOVED baris dihapus (konten di luar struktur HTML)."
            else
              rm -f "$file.tmp"
              echo "â­ï¸  Tidak ada konten di luar struktur HTML."
            fi
            echo "--------------------------------------"
          done

          echo "ğŸ“Š Total file yang diproses: $FILE_COUNT"
          echo "ğŸ—‘ï¸  Total baris dihapus: $TOTAL_REMOVED"
          echo "TOTAL_REMOVED=$TOTAL_REMOVED" >> $GITHUB_ENV
          echo "FILE_COUNT=$FILE_COUNT" >> $GITHUB_ENV

      - name: ğŸ§¾ Cek perubahan
        run: |
          if git diff --quiet; then
            echo "âœ… Tidak ada perubahan ditemukan."
            echo "NO_CHANGES=true" >> $GITHUB_ENV
          else
            echo "ğŸ“ Ada file yang diperbarui."
            echo "NO_CHANGES=false" >> $GITHUB_ENV
          fi

      - name: ğŸ§© Commit & buat PR otomatis
        if: env.NO_CHANGES != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "âœ‚ï¸ Hapus konten di luar struktur HTML"
          title: "âœ‚ï¸ Bersihkan isi sebelum <!DOCTYPE html> dan setelah </html>"
          body: |
            Workflow ini otomatis membersihkan seluruh file **${{ github.event.inputs.target_folder }}/*.html**:

            - ğŸ”½ Menghapus konten **apa pun sebelum** `<!DOCTYPE html>` (case-insensitive)
            - ğŸ”¼ Menghapus konten **apa pun setelah** `</html>` (case-insensitive)
            - ğŸ“Š Menampilkan jumlah baris yang dihapus per file
            - ğŸ§¾ Log ringkasan total file & baris yang dihapus di seluruh folder

            **Hasil Eksekusi Terakhir:**
            - File yang diproses: `${{ env.FILE_COUNT }}`
            - Total baris yang dihapus: `${{ env.TOTAL_REMOVED }}`

          base: main
