name: ✂️ Bersihkan Sebelum & Setelah HTML

on:
  workflow_dispatch:
    inputs:
      target_folder:
        description: "Folder target (misalnya: artikel)"
        required: true
        default: "artikel"

permissions:
  contents: write
  pull-requests: write

jobs:
  clean-html-edges:
    runs-on: ubuntu-latest

    steps:
      - name: 📦 Checkout kode
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ✂️ Bersihkan konten sebelum <!DOCTYPE html> dan setelah </html>
        id: clean
        run: |
          TARGET="${{ github.event.inputs.target_folder }}"
          echo "🧹 Memproses semua file HTML di folder: $TARGET"
          TOTAL_REMOVED=0
          FILE_COUNT=0

          find "$TARGET" -type f -name "*.html" | while read -r file; do
            ((FILE_COUNT++))
            echo "🔧 Membersihkan: $file"

            TOTAL_BEFORE=$(wc -l < "$file")

            # Ambil hanya dari <!DOCTYPE html> hingga </html> (case-insensitive)
            awk 'BEGIN{IGNORECASE=1}
                 /<!DOCTYPE[[:space:]]+html>/,/<\/html>/ {print}
                 /<\/html>/ {exit}' "$file" > "$file.tmp"

            TOTAL_AFTER=$(wc -l < "$file.tmp")
            REMOVED=$((TOTAL_BEFORE - TOTAL_AFTER))
            TOTAL_REMOVED=$((TOTAL_REMOVED + (REMOVED > 0 ? REMOVED : 0)))

            if (( REMOVED > 0 )); then
              mv "$file.tmp" "$file"
              echo "✅ $REMOVED baris dihapus (konten di luar struktur HTML)."
            else
              rm -f "$file.tmp"
              echo "⏭️  Tidak ada konten di luar struktur HTML."
            fi
            echo "--------------------------------------"
          done

          echo "📊 Total file yang diproses: $FILE_COUNT"
          echo "🗑️  Total baris dihapus: $TOTAL_REMOVED"
          echo "TOTAL_REMOVED=$TOTAL_REMOVED" >> $GITHUB_ENV
          echo "FILE_COUNT=$FILE_COUNT" >> $GITHUB_ENV

      - name: 🧾 Cek perubahan
        run: |
          if git diff --quiet; then
            echo "✅ Tidak ada perubahan ditemukan."
            echo "NO_CHANGES=true" >> $GITHUB_ENV
          else
            echo "📝 Ada file yang diperbarui."
            echo "NO_CHANGES=false" >> $GITHUB_ENV
          fi

      - name: 🧩 Commit & buat PR otomatis
        if: env.NO_CHANGES != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "✂️ Hapus konten di luar struktur HTML"
          title: "✂️ Bersihkan isi sebelum <!DOCTYPE html> dan setelah </html>"
          body: |
            Workflow ini otomatis membersihkan seluruh file **${{ github.event.inputs.target_folder }}/*.html**:

            - 🔽 Menghapus konten **apa pun sebelum** `<!DOCTYPE html>` (case-insensitive)
            - 🔼 Menghapus konten **apa pun setelah** `</html>` (case-insensitive)
            - 📊 Menampilkan jumlah baris yang dihapus per file
            - 🧾 Log ringkasan total file & baris yang dihapus di seluruh folder

            **Hasil Eksekusi Terakhir:**
            - File yang diproses: `${{ env.FILE_COUNT }}`
            - Total baris yang dihapus: `${{ env.TOTAL_REMOVED }}`

          base: main
