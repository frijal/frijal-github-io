name: ğŸ”„ Proses ArtikelX & Smart Build

on:
  push:
    branches: ["main"]
    paths:
      - "artikelx/*.html"
      - "ext/**"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  proses_artikel:
    name: ğŸ§© Proses Artikel Baru
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§­ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸª„ Jalankan Find-and-Replace
        run: |
          shopt -s nullglob
          for file in artikelx/*.html; do
            echo "ğŸª„ Memproses $file"
            perl -pi -w -e 's#frijal.github.io/#frijal.pages.dev/#g' "$file"
            perl -pi -w -e 's#bak.xo.je/#frijal.pages.dev/#g' "$file"
            perl -pi -w -e 's#https://frijal.pages.dev/assets/apple-touch-icon.png#https://frijal.pages.dev/ext/icons/apple-touch-icon.png#g' "$file"
            perl -pi -w -e 's#YOUR_APP_ID#1471267430691023#g' "$file"
            perl -pi -w -e 's#YOUR_FACEBOOK_APP_ID#1471267430691023#g' "$file"
            perl -pi -w -e 's#nama_twitter_anda#frijal#g' "$file"
            perl -pi -w -e 's/Â©/ğŸ„¯/g' "$file"
            perl -pi -w -e 's#Komentar#Jaga Data Pribadi Tetap Aman.#g' "$file"
            perl -pi -w -e 's#Bak Xo Je#Jaga Data Pribadi Tetap Aman.#g' "$file"
          done
          shopt -u nullglob

      - name: ğŸ§± Tambahkan CSS/JS & Elemen Tambahan
        run: |
          shopt -s nullglob
          echo "ğŸ§© Menambahkan elemen tambahan ke file HTML (dengan pengecekan duplikat)..."
          for file in artikelx/*.html; do
            echo "ğŸ”§ Memproses: $file"

            # 1ï¸âƒ£ CSS
            if ! grep -q '<link rel="stylesheet" href="/ext/marquee-url.css">' "$file"; then
              sed -i '/<\/head>/i <link rel="stylesheet" href="/ext/marquee-url.css">' "$file"
            fi

            # 2ï¸âƒ£ div iposbrowser
            if ! grep -q '<div id="iposbrowser"></div>' "$file"; then
              sed -i '/<\/h1>/a <div id="iposbrowser"></div>' "$file"
            fi

            # 3ï¸âƒ£ floating search
            if ! grep -q 'class="search-floating-container"' "$file"; then
              sed -i '/<\/body>/i <div class="search-floating-container"><input type="text" id="floatingSearchInput" placeholder="cari artikel..." autocomplete="off"><span id="floatingSearchClear" class="clear-button">âŒ</span><div id="floatingSearchResults" class="floating-results-container"></div></div>' "$file"
            fi

            # 4ï¸âƒ£ marquee + js
            if ! grep -q 'id="related-marquee-section"' "$file"; then
              sed -i '/<\/body>/i <section id="related-marquee-section"><div id="related-marquee-container"></div></section><script defer src="/ext/marquee-url.js"></script>' "$file"
            fi

            # 5ï¸âƒ£ iposbrowser.js
            if ! grep -q '/ext/iposbrowser.js' "$file"; then
              sed -i '/<\/body>/i <script defer src="/ext/iposbrowser.js"></script>' "$file"
            fi
          done
          shopt -u nullglob

      - name: ğŸ“‚ Pindahkan ke folder artikel/
        run: |
          echo "ğŸ“¦ Memindahkan file dari artikelx/ ke artikel/"
          mkdir -p artikel
          mv -f artikelx/*.html artikel/ || true

      - name: ğŸ’¾ Commit hasil proses
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          if git diff --quiet; then
            echo "âœ… Tidak ada perubahan dari proses artikel."
          else
            git add artikelx artikel
            git commit -m "ğŸ§± Proses ArtikelX otomatis"
            git push
          fi

  smart_build:
    name: âš™ï¸ Smart Build & Deploy
    runs-on: ubuntu-latest
    needs: proses_artikel

    steps:
      - name: ğŸ” Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Check for Relevant Changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            src:
              - 'artikel/**'
              - 'ext/**'
              - 'img/**'
              - 'index.html'
              - 'sitemap.html'
              - 'feed.html'

      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¦ Install dependencies
        run: |
          [ -f package.json ] && npm ci || echo "No package.json found â€” skipping install."

      - name: ğŸ§­ Generate metadata, sitemap, RSS, index
        if: steps.filter.outputs.src == 'true'
        run: |
          node ext/generator.js || true
          node ext/rss.js || true

      - name: ğŸ“¸ Generate screenshots
        if: steps.filter.outputs.src == 'true'
        run: |
          npm install puppeteer --no-save
          node ext/screenshot-puppeteer.js

      - name: ğŸ§¹ Cleanup
        if: steps.filter.outputs.src == 'true'
        run: rm -rf tmp/ __pycache__/

      - name: ğŸ’¾ Commit hasil build
        if: steps.filter.outputs.src == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --cached --quiet || git commit -m "ğŸ¤– Auto-build update (Smart Trigger)"
          git push || echo "No changes to push"

      - name: âœ… Skip message
        if: steps.filter.outputs.src == 'false'
        run: echo "âœ… Tidak ada perubahan relevan, build dilewati."
