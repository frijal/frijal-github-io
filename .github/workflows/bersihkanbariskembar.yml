name: 🧹 Hapus Duplikat Elemen HTML (Preserve Order + Count)

on:
  workflow_dispatch:
    inputs:
      target_folder:
        description: "Folder target (misalnya: artikel)"
        required: true
        default: "artikel"

permissions:
  contents: write
  pull-requests: write

jobs:
  clean-duplicates:
    runs-on: ubuntu-latest

    steps:
      - name: 📦 Checkout kode
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔍 Cek duplikat manual
        run: |
          find ${{ github.event.inputs.target_folder }} -type f -name "*.html" | while read -r file; do
            echo "🔍 Memeriksa: $file"
            for pattern in \
              '<link rel="stylesheet" href="/ext/marquee-url.css">' \
              '<div id="iposbrowser"></div>' \
              '<div class="search-floating-container"><input type="text" id="floatingSearchInput"></div>' \
              '<section id="related-marquee-section"><div id="related-marquee-container"></div></section>' \
              '<script defer src="/ext/marquee-url.js"></script>' \
              '<script defer src="/ext/iposbrowser.js"></script>'
            do
              count=$(grep -F "$pattern" "$file" | wc -l)
              if [ "$count" -gt 1 ]; then
                echo "⚠️  Duplikat ditemukan ($count×): $pattern"
              fi
            done
          done

      - name: 🧹 Hapus duplikat tapi pertahankan urutan pertama
        run: |
          total_removed=0
          find ${{ github.event.inputs.target_folder }} -type f -name "*.html" | while read -r file; do
            tmpfile=$(mktemp)
            echo "🧽 Membersihkan $file"
            removed=0
            awk '
              BEGIN {
                patterns[1] = "<link rel=\"stylesheet\" href=\"/ext/marquee-url.css\">"
                patterns[2] = "<div id=\"iposbrowser\"></div>"
                patterns[3] = "<div class=\"search-floating-container\"><input type=\"text\" id=\"floatingSearchInput\"></div>"
                patterns[4] = "<section id=\"related-marquee-section\"><div id=\"related-marquee-container\"></div></section>"
                patterns[5] = "<script defer src=\"/ext/marquee-url.js\"></script>"
                patterns[6] = "<script defer src=\"/ext/iposbrowser.js\"></script>"
              }
              {
                keep=1
                for (i in patterns) {
                  if (index($0, patterns[i]) > 0) {
                    if (seen[i] == 1) {
                      keep=0
                      removed[i]++
                      break
                    } else {
                      seen[i]=1
                    }
                  }
                }
                if (keep==1) print $0
              }
              END {
                total=0
                for (i in removed) total += removed[i]
                if (total > 0)
                  printf("🗑️  %d duplikat dihapus dari file ini.\n", total)
              }
            ' "$file" > "$tmpfile" && mv "$tmpfile" "$file"
          done

      - name: 🧾 Cek apakah ada perubahan
        run: |
          if git diff --quiet; then
            echo "✅ Tidak ada duplikat yang dihapus."
            echo "NO_CHANGES=true" >> $GITHUB_ENV
          else
            echo "✅ Perubahan terdeteksi, siap untuk commit."
            echo "NO_CHANGES=false" >> $GITHUB_ENV
          fi

      - name: 🧩 Commit dan buat PR otomatis
        if: env.NO_CHANGES != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "🧹 Hapus duplikat elemen HTML (preserve order + count)"
          title: "🧹 Bersihkan duplikat elemen HTML (Preserve Order + Count)"
          body: |
            Workflow otomatis ini menghapus duplikat elemen HTML namun mempertahankan posisi asli elemen pertama.

            Elemen yang dicek:
            - `<link rel="stylesheet" href="/ext/marquee-url.css">`
            - `<div id="iposbrowser"></div>`
            - `<div class="search-floating-container">…</div>`
            - `<section id="related-marquee-section">…</section>`
            - `<script defer src="/ext/marquee-url.js"></script>`
            - `<script defer src="/ext/iposbrowser.js"></script>`

            Setiap file yang dibersihkan akan menampilkan jumlah duplikat yang dihapus di log workflow.
          base: main
