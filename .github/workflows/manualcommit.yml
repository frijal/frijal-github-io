name: Generate & Ping Sitemap (Manual Commit)

on:
  push:
    branches:
      - main
    paths:
      - 'artikel/**'
  schedule:
    - cron: "0 4 * * *"   # ping sitemap tiap hari jam 04:00 UTC
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm init -y
          npm install jsdom
      
      - name: Generate artikel.json & sitemap.xml
        run: |
          cat > ext/generate.js <<'EOF'
          const fs = require("fs");
          const { JSDOM } = require("jsdom");

          const BASE_URL = "https://frijal.github.io/artikel/";
          const FALLBACK_IMG = "thumbnail.jpg";

          function titleToCategory(title){
            const t = title.toLowerCase();
            const cats = [
              {name: "ðŸ“½ï¸ Multimedia & Editing", k:["ffmpeg","video","film","audio","mp3","ogg","rekam","convert","split","cut","durasi","imagemagick","resize","format","potong","watermark","foto","gambar","pdf","gabung","kompres","scan","ghostscript","pdftk","vlc","multimedia","codec"]},
              {name: "ðŸ§ Linux & Open Source", k:["linux","libreoffice","openoffice","perl","ubuntu","distro","lts","live usb","conky","fedora","debian","arch","slackware","nixos","opensuse","blankon","mirror","repo","apt","yum","rsync","grub","chroot","dpkg","open source","oss","foss","komunitas","kpli","gnome","kde","compiz","desktop","ubuntu party"]},
              {name: "ðŸ“š Islam & Kehidupan", k:["islam","shalat","akidah","aqidah","qunut","istigfar","istighfar","mukjizat","masjid","madinah","imam","risalah","nabi","quran","hadis","hijriyah","muslim","doa","hukum","halal","haram","syariat","fiqh","hijab","ramadhan","maulid","piagam madinah","mushaf utsman","tabut","iman","sabar","ghibah","fitnah","sombong","salam","janji"]},
              {name: "ðŸžï¸ Budaya, Kuliner & Lifestyle", k:["kuliner","obat","sakit","pecel","minuman","jagung","kerupuk","angkringan","kurma","kopi","camilan","wisata","jogja","bali","bekapai","hotel","bandara","respiro","tidur","kesehatan","psikotes","wanita","bahagia"]},
              {name: "ðŸ“° Catatan & Sosial", k:["catatan","pt","kopdar","sejarah","indonesia","peradaban","sahabat","kota","rencana","kreativitas","ibu","perjalanan","bisnis","perusahaan","ekspedisi","aturan","harian","cuti","nostalgia","renungan","golput","duit","pekerjaan","kerja halal","perencanaan","produktifitas","sahabat","fenomena","sktm","ppdb"]},
              {name: "ðŸ’» Windows & Teknologi Umum", k:["windows","learning","cpu","samba","jaringan","software","terminal","github","shutdown","hdd","ssd","refresh","optimasi","bootloader","virtualbox","keyring","laptop","osborne1","baterai","mic","wifi","amd","cooling","phishing","eula","lisensi","piracy"]}
            ];
            return (cats.find(c=>c.k.some(k=>t.includes(k)))||{name:"ðŸ—‚ï¸ Lainnya"}).name;
          }

          const files = fs.readdirSync("artikel").filter(f=>f.endsWith(".html"));
          const grouped = {};
          const sitemapUrls = [];

          files.forEach(f=>{
            const html = fs.readFileSync(`artikel/${f}`,"utf-8");
            const dom = new JSDOM(html);
            const doc = dom.window.document;

            const title = doc.querySelector("title")?.textContent || f;
            const category = titleToCategory(title);
            if(!grouped[category]) grouped[category] = [];
            grouped[category].push([title,f]);

            let img = doc.querySelector('meta[property="og:image"]')?.content
                   || doc.querySelector('meta[name="twitter:image"]')?.content
                   || doc.querySelector("main section img")?.src
                   || FALLBACK_IMG;
            if(!img.startsWith("http")) img = BASE_URL + img;

            sitemapUrls.push({
              loc: BASE_URL + f,
              lastmod: new Date().toISOString().split("T")[0],
              priority: 0.6,
              changefreq: "monthly",
              img
            });
          });

          fs.writeFileSync("ext/artikel.json", JSON.stringify(grouped, null, 2));

          let sitemap = `<?xml version="1.0" encoding="UTF-8"?>\n`;
          sitemap += `<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" xmlns:image="http://www.google.com/schemas/sitemap-image/1.1">\n`;
          sitemapUrls.forEach(u=>{
            sitemap += `  <url>\n`;
            sitemap += `    <loc>${u.loc}</loc>\n`;
            sitemap += `    <lastmod>${u.lastmod}</lastmod>\n`;
            sitemap += `    <priority>${u.priority}</priority>\n`;
            sitemap += `    <changefreq>${u.changefreq}</changefreq>\n`;
            if(u.img){
              sitemap += `    <image:image>\n`;
              sitemap += `      <image:loc>${u.img}</image:loc>\n`;
              sitemap += `    </image:image>\n`;
            }
            sitemap += `  </url>\n`;
          });
          sitemap += `</urlset>\n`;
          fs.writeFileSync("ext/sitemap.xml", sitemap);

          console.log("âœ… artikel.json & sitemap.xml generated in ext/");
          EOF

          node ext/generate.js

      - name: Move sitemap.xml to root
        run: cp ext/sitemap.xml ./sitemap.xml

 
