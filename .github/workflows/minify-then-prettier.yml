name: Optimize Files (HTML & JS)

on:
  workflow_dispatch:
    inputs:
      delay:
        description: "Delay (detik) sebelum menjalankan Prettier"
        required: true
        default: "300"
      runPrettier:
        description: "Jalankan Prettier setelah minify?"
        required: true
        default: "true"
      targetDirs:
        description: "Daftar folder target (pisahkan dengan koma, contoh: artikel,docs,pages)"
        required: true
        default: "artikel"
      extensions:
        description: "Ekstensi file yang diproses (pisahkan dengan koma, contoh: html,js)"
        required: true
        default: "html,js"

jobs:
  optimize:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install -g prettier html-minifier terser

      - name: Minify Files
        run: |
          IFS=',' read -ra DIRS <<< "${{ github.event.inputs.targetDirs }}"
          IFS=',' read -ra EXTS <<< "${{ github.event.inputs.extensions }}"
          for dir in "${DIRS[@]}"; do
            echo "🔎 Processing folder: $dir"
            if [ -d "$dir" ]; then
              for ext in "${EXTS[@]}"; do
                case "$ext" in
                  html)
                    find "$dir"/ -name "*.html" | while read file; do
                      html-minifier \
                        --collapse-whitespace \
                        --remove-comments \
                        --minify-css true \
                        --minify-js true \
                        "$file" -o "$file"
                    done
                    ;;
                  js)
                    find "$dir"/ -name "*.js" | while read file; do
                      terser "$file" -c -m -o "$file"
                    done
                    ;;
                  *)
                    echo "⚠️ Ekstensi $ext belum didukung"
                    ;;
                esac
              done
            else
              echo "⚠️ Folder $dir tidak ditemukan"
            fi
          done

      - name: Wait before Prettier
        if: ${{ github.event.inputs.runPrettier == 'true' }}
        run: sleep ${{ github.event.inputs.delay }}

      - name: Prettier Format
        if: ${{ github.event.inputs.runPrettier == 'true' }}
        run: |
          IFS=',' read -ra DIRS <<< "${{ github.event.inputs.targetDirs }}"
          IFS=',' read -ra EXTS <<< "${{ github.event.inputs.extensions }}"
          for dir in "${DIRS[@]}"; do
            if [ -d "$dir" ]; then
              for ext in "${EXTS[@]}"; do
                prettier --write "$dir/**/*.${ext}"
              done
            fi
          done

      - name: Commit changes
        run: |
          git config --global user.name "Auto Optimizer"
          git config --global user.email "actions@github.com"
          IFS=',' read -ra DIRS <<< "${{ github.event.inputs.targetDirs }}"
          for dir in "${DIRS[@]}"; do
            if [ -d "$dir" ]; then
              git add "$dir"/*.{html,js} || true
            fi
          done
          git commit -m "♻️ Optimized (${{ github.event.inputs.extensions }}) in ${{ github.event.inputs.targetDirs }}" || echo "No changes to commit"
          git push
        continue-on-error: true
