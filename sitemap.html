<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daftar Isi Interaktif - Pelan Kiri FRijal</title>
<meta name="description" content="Jelajahi beragam topik mulai dari panduan sistem operasi Windows dan Linux, Ubuntu, Debian, Arch, RedHat, Fedora, inspirasi kehidupan dan perjalanan, komunitas, hingga artikel seputar religi dan Islam untuk Muslim, serta tips seputar pekerjaan.">
<link rel="stylesheet" href="ext/style.css">
</head>
<body>
<!-- Marquee -->
<div id="marquee-container"><div id="marquee-content">Memuat judul artikel...</div></div>

<div><footer class="page-footer"><div id="footerInfo"></div></footer></div>
<!-- Search -->
<input type="text" id="search" placeholder="Cari judul...">

<!-- Expand/Collapse TOC -->
<button id="tocToggle">Collapse TOC</button>

<!-- TOC -->
<div id="toc"></div>
<div id="totalCount">Total artikel: 0</div>

<!-- Script gradient eksternal -->
<script src="ext/gradient-random-contrast.min.js"></script>

<script>
const visitedLinks = JSON.parse(localStorage.getItem("visitedLinks")||"[]");

async function loadTOC() {
  try {
    const res = await fetch("artikel.json");
    const data = await res.json();
    const toc = document.getElementById("toc");
    toc.innerHTML = "";

    const totalCount = document.getElementById("totalCount");

    // --- Kelompokkan data per kategori ---
    const grouped = {};
    Object.keys(data).forEach(cat => {
      grouped[cat] = data[cat].map(arr => ({
        title: arr[0],
        file: arr[1],
        category: cat
      }));
    });

    // --- Hitung total artikel ---
    const totalArticles = Object.values(grouped).reduce((sum, arr) => sum + arr.length, 0);
    totalCount.textContent = `Total artikel: ${totalArticles}`;

    // --- Urutkan kategori berdasarkan jumlah artikel terbanyak ---
    Object.keys(grouped)
      .sort((a, b) => grouped[b].length - grouped[a].length)
      .forEach(cat => {
        const catDiv = document.createElement("div");
        catDiv.className = "category";

        catDiv.innerHTML = `
          <div class="category-header">
            ${cat} <span class="badge">${grouped[cat].length}</span>
          </div>
          <div class="toc-list"></div>
        `;

        const catList = catDiv.querySelector(".toc-list");

        // --- Tambahkan item TOC ---
        grouped[cat].forEach((item, i) => {
          const el = document.createElement("div");
          el.className = "toc-item";
          el.dataset.text = item.title.toLowerCase();

          const a = document.createElement("a");
          a.href = `artikel/${item.file}`;
          a.target="_blank";
          a.textContent = `${i + 1}. ${item.title}`;

          const statusSpan = document.createElement("span");
          if (visitedLinks.includes(item.file)) {
            statusSpan.className = "label-visited";
            statusSpan.textContent = "sudah dibaca 👍";
            a.classList.add("visited");
          } else {
            statusSpan.className = "label-new";
            statusSpan.textContent = "📚 belum dibaca";
          }

          a.addEventListener("click", () => {
            if (!visitedLinks.includes(item.file)) {
              visitedLinks.push(item.file);
              localStorage.setItem("visitedLinks", JSON.stringify(visitedLinks));
              statusSpan.className = "label-visited";
              statusSpan.textContent = "sudah dibaca 👍";
              a.classList.add("visited");
            }
          });

          const titleDiv = document.createElement("div");
          titleDiv.className = "toc-title";
          titleDiv.appendChild(a);
          titleDiv.appendChild(statusSpan);
          el.appendChild(titleDiv);
          catList.appendChild(el);
        });

        // --- Toggle kategori individu ---
        catDiv.querySelector(".category-header").addEventListener("click", () => {
          catList.style.display = catList.style.display === "block" ? "none" : "block";
          updateTOCToggleText();
        });

        toc.appendChild(catDiv);
      });

    // --- Marquee ---
    const m = document.getElementById("marquee-content");
    const allArticles = Object.values(grouped).flat();

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    const shuffled = shuffle(allArticles);
    m.innerHTML = shuffled
      .map(d => `<a href="artikel/${d.file}" target="_blank">${d.title}</a>`)
      .join(" • ");

    // --- Search ---
    document.getElementById("search").addEventListener("input", function () {
      const term = this.value.toLowerCase();
      let countVisible = 0;

      document.querySelectorAll(".category").forEach(category => {
        let catVisible = false;
        category.querySelectorAll(".toc-item").forEach(item => {
          const text = item.dataset.text;
          const link = item.querySelector("a");
          if (term && text.includes(term)) {
            item.style.display = "flex";
            catVisible = true;
            countVisible++;
            const regex = new RegExp(`(${term})`, "gi");
            link.innerHTML = link.textContent.replace(regex, '<span class="highlight">$1</span>');
          } else {
            item.style.display = term ? "none" : "flex";
            link.innerHTML = link.textContent;
            if (!term) countVisible++;
          }
        });
        category.style.display = catVisible ? "block" : (term ? "none" : "block");
        const tocList = category.querySelector(".toc-list");
        tocList.style.display = catVisible ? "block" : tocList.style.display;
      });

      totalCount.textContent = `Total artikel: ${countVisible}`;
      updateTOCToggleText();
    });

    // --- Tombol global Buka/Tutup ---
    let tocCollapsed = false;
    const tocToggleBtn = document.getElementById("tocToggle");

    function updateTOCToggleText() {
      const allCollapsed = Array.from(document.querySelectorAll(".toc-list"))
        .every(list => list.style.display === "none");
      tocCollapsed = allCollapsed;
      tocToggleBtn.textContent = tocCollapsed ? "Buka" : "Tutup";
    }

    tocToggleBtn.addEventListener("click", () => {
      tocCollapsed = !tocCollapsed;
      document.querySelectorAll(".toc-list").forEach(list => {
        list.style.display = tocCollapsed ? "none" : "block";
      });
      tocToggleBtn.textContent = tocCollapsed ? "Buka" : "Tutup";
    });

    // --- Inisialisasi tombol ---
    updateTOCToggleText();

    // --- Terapkan gradient random setelah render ---
    const categories = Object.keys(grouped);
    const gradientMap = generateGradientMap(categories);
    document.querySelectorAll(".category-header").forEach(el => {
      const name = el.textContent.split(" ")[0].trim(); // ambil ikon+nama kategori
      if (gradientMap[el.textContent.trim()]) {
        el.style.background = gradientMap[el.textContent.trim()];
      }
    });

  } catch (e) {
    console.error("Gagal load artikel.json:", e);
  }
}

loadTOC();
</script>
</body>
</html>
