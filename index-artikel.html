<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generate artikel.json & Sitemap Otomatis</title>
<style>
body { font-family: Arial, sans-serif; padding:20px; background:#f5f5f5; }
h1 { text-align:center; }
textarea { width:100%; height:150px; padding:10px; font-family: monospace; font-size:14px; margin-top:10px; }
button { padding:10px 15px; font-size:16px; margin-top:10px; cursor:pointer; margin-right:10px; }
#log { background:#111; color:#0f0; padding:10px; height:300px; overflow-y:auto; font-family: monospace; font-size:13px; margin-top:15px; border-radius:4px; white-space: pre-wrap; }
#progressContainer { margin-top:15px; }
#progressBar { width:0%; height:20px; background:#4caf50; border-radius:4px; }
#progressText { text-align:right; font-size:12px; margin-top:2px; }
</style>
</head>
<body>

<h1>Generate artikel.json & Sitemap Otomatis</h1>

<div id="progressContainer">
  <div style="background:#ddd; border-radius:4px; overflow:hidden; height:20px;">
    <div id="progressBar"></div>
  </div>
  <div id="progressText">0 / 0 files</div>
</div>

<textarea id="jsonOutput" readonly></textarea>
<br>
<button id="downloadBtn">‚¨áÔ∏è Download JSON</button>
<button id="copyBtn">üìã Copy JSON</button>
<button id="refreshBtn">üîÑ Refresh Scan</button>
<button id="clearLogBtn">üßπ Clear Log</button>

<h3>Verbose Log</h3>
<div id="log"></div>

<script>
// --------- Utility ---------
function log(msg){
  const logBox = document.getElementById("log");
  logBox.textContent += msg + "\n";
  logBox.scrollTop = logBox.scrollHeight;
}
function sleep(ms){ return new Promise(resolve=>setTimeout(resolve, ms)); }

// --------- Repo config ---------
const owner = "frijal";
const repo = "frijal.github.io";
const folder = "artikel";

// --------- Kategori ---------
function titleToCategory(title){
  const t = title.toLowerCase();
  const cats = [
    {name: "Arch", k:["arch","manjaro","cachyos","endeavouros"]},
    {name: "Debian", k:["debian","ubuntu","mint"]},
    {name: "Desktop", k:["kde","gnome","xfce","desktop environment"]},
    {name: "Religi", k:["allah","shalat","agama","puasa","nabi","islam"]}
    // bisa ditambah kategori lain sesuai kebutuhan
  ];
  return (cats.find(c=>c.k.some(k=>t.includes(k)))||{name:"Lainnya"}).name;
}

// --------- GitHub API rate limit ---------
async function checkRateLimit(){
  try{
    const res = await fetch('https://api.github.com/rate_limit');
    const data = await res.json();
    const remaining = data.rate.remaining;
    const resetTime = data.rate.reset*1000;
    log(`üîπ GitHub API Remaining: ${remaining}, Reset at: ${new Date(resetTime).toLocaleTimeString()}`);
    return {remaining, resetTime};
  }catch(err){
    log("‚ùå Gagal cek rate limit: "+err.message);
    return {remaining:1, resetTime:Date.now()+60000};
  }
}

async function fetchFileWithRateLimit(file){
  while(true){
    const {remaining, resetTime} = await checkRateLimit();
    if(remaining>5) break;
    const waitMs = resetTime - Date.now() + 1000;
    log(`‚è≥ Menunggu ${Math.ceil(waitMs/1000)}s karena rate limit hampir habis...`);
    await sleep(waitMs);
  }
  return await fetch(file.download_url).then(r=>r.text());
}

// --------- Main ---------
let totalFiles=0, completedFiles=0, startTimeProgress=0;

async function generateJSONRateLimitAware(){
  document.getElementById("jsonOutput").value="";
  document.getElementById("log").textContent="";
  document.getElementById("progressBar").style.width="0%";
  document.getElementById("progressText").textContent="0 / 0 files";
  startTimeProgress = Date.now();
  completedFiles = 0;

  try{
    log("üîç Mengambil daftar file dari repo...");
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${folder}`);
    const files = await res.json();

    if(!Array.isArray(files)) throw new Error(files.message || "Response bukan array!");

    const htmlFiles = files.filter(f=>f.type==="file" && f.name.endsWith(".html"));
    totalFiles = htmlFiles.length;
    log(`üìÇ Ditemukan ${totalFiles} file HTML`);

    const grouped = {};
    const seenTitles = new Set();
    const duplicates = [];

    let concurrency = Math.min(10, totalFiles);
    let index = 0;

    async function worker(){
      while(index<htmlFiles.length){
        const i=index++;
        const f = htmlFiles[i];
        try{
          const htmlText = await fetchFileWithRateLimit(f);
          const doc = new DOMParser().parseFromString(htmlText,'text/html');
          const title = doc.querySelector("title")?.innerText || f.name;

          // ambil og:image
          const metaImg = doc.querySelector('meta[property="og:image"]')?.content || 'thumbnail.jpg';

          if(seenTitles.has(title)){
            duplicates.push([title,f.name]);
          } else {
            seenTitles.add(title);
            const category = titleToCategory(title);
            if(!grouped[category]) grouped[category]=[];
            grouped[category].push({title,fname:f.name,img:metaImg});
          }
        }catch(e){
          if(!grouped["Lainnya"]) grouped["Lainnya"]=[];
          grouped["Lainnya"].push({title:f.name,fname:f.name,img:"thumbnail.jpg"});
        }

        completedFiles++;
        const percent = Math.round((completedFiles/totalFiles)*100);
        document.getElementById("progressBar").style.width = percent+"%";
        const elapsed = (Date.now()-startTimeProgress)/1000;
        const eta = Math.round((elapsed/completedFiles)*(totalFiles-completedFiles));
        document.getElementById("progressText").textContent = `${completedFiles} / ${totalFiles} files (${percent}%) | ETA: ${eta}s`;
      }
    }

    await Promise.all(Array(concurrency).fill().map(()=>worker()));

    // generate JSON
    const jsonOutput = JSON.stringify(grouped,null,2);
    document.getElementById("jsonOutput").value = jsonOutput;

    log("\nüìä Ringkasan per kategori:");
    Object.entries(grouped).sort((a,b)=>b[1].length-a[1].length)
      .forEach(([cat,arr])=>log(`   - ${cat}: ${arr.length} item`));
    log(`\nüìà Total file: ${totalFiles}, Duplikat: ${duplicates.length}`);
    log(`‚è±Ô∏è Waktu total: ${(Date.now()-startTimeProgress)/1000}s`);
    log("\n‚úÖ Proses selesai!");

  }catch(err){
    log("‚ùå Error: "+err.message);
    document.getElementById("jsonOutput").value="Error: "+err.message;
  }
}

// --------- Tombol ---------
document.getElementById("downloadBtn").addEventListener("click",()=>{
  const blob = new Blob([document.getElementById("jsonOutput").value],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="artikel.json"; a.click();
  URL.revokeObjectURL(url);
});
document.getElementById("copyBtn").addEventListener("click",async()=>{
  try{ await navigator.clipboard.writeText(document.getElementById("jsonOutput").value); log("üìã JSON berhasil dicopy!"); }
  catch(err){ log("‚ùå Gagal copy JSON: "+err.message); }
});
document.getElementById("refreshBtn").addEventListener("click",()=>{ generateJSONRateLimitAware(); });
document.getElementById("clearLogBtn").addEventListener("click",()=>{ document.getElementById("log").textContent=""; });

// otomatis run
generateJSONRateLimitAware();
</script>
</body>
</html>
