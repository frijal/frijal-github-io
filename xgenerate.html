<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generate artikel.json Otomatis (Ultimate Visual)</title>
<style>
body { font-family: Arial, sans-serif; padding:20px; background:#f5f5f5; }
h1 { text-align:center; }
textarea { width:100%; height:150px; padding:10px; font-family: monospace; font-size:14px; margin-top:10px; }
button { padding:10px 15px; font-size:16px; margin-top:10px; cursor:pointer; margin-right:10px; }
#log { background:#111; color:#0f0; padding:10px; height:250px; overflow-y:auto; font-family: monospace; font-size:13px; margin-top:15px; border-radius:4px; white-space: pre-wrap; }
#progressContainer { margin-top:15px; }
#progressBarTotal { width:0%; height:20px; background:#4caf50; border-radius:4px; }
#progressTextTotal { text-align:right; font-size:12px; margin-top:2px; }
.categoryBarOuter { background:#ddd; border-radius:4px; overflow:hidden; height:16px; margin-top:5px; }
.categoryBarInner { width:0%; height:100%; background:#2196F3; }
.categoryLabel { text-align:right; font-size:11px; }
</style>
</head>
<body>

<h1>Generate artikel.json Otomatis (Ultimate Visual)</h1>
<p>JSON muncul di bawah. Download, copy, atau push manual ke repo.</p>

<div id="progressContainer">
  <div style="background:#ddd; border-radius:4px; overflow:hidden; height:20px;">
    <div id="progressBarTotal"></div>
  </div>
  <div id="progressTextTotal">0 / 0 files | ETA: 0s</div>
</div>

<div id="categoryProgressContainer"></div>

<textarea id="jsonOutput" readonly></textarea>
<br>
<button id="downloadBtn">‚¨áÔ∏è Download JSON</button>
<button id="copyBtn">üìã Copy JSON</button>
<button id="refreshBtn">üîÑ Refresh Scan</button>
<button id="clearLogBtn">üßπ Clear Log</button>

<h3>Verbose Log</h3>
<div id="log"></div>

<script>
// ----------------- Utility -----------------
function log(msg){
  const logBox = document.getElementById("log");
  logBox.textContent += msg + "\n";
  logBox.scrollTop = logBox.scrollHeight;
}
function sleep(ms){ return new Promise(resolve=>setTimeout(resolve, ms)); }

// ----------------- Repo config -----------------
const owner = "frijal";
const repo = "frijal.github.io";
const folder = "artikel";

// ----------------- Kategori -----------------
function titleToCategory(title){
  const t = title.toLowerCase();
  const cats = [
    {name: "Arch", k:["arch","manjaro","cachyos","endeavouros","artix","parabola","blackarch","garuda","antergos","arco"]},
    {name: "Debian", k:["debian","ubuntu","mint","mx linux","elementary","puppy","kali","kubuntu","xubuntu","lubuntu","zorin","popos","deepin","tails","raspbian","devuan"]},
    {name: "Desktop", k:["kde","hyperland","caja","ukui","pantheon","deepin","lxde","budgie","mate","gnome","cinnamon","xfce","desktop environment","fluxbox","openbox","i3","sway","awesome","dwm","enlightenment","wayland","xorg","window manager"]},
    {name: "Kehidupan", k:["hidup","uang","dosa","alasan","bapak","ibu","anak","kehidupan","tidur","sahabat","teman","sombong","wanita","pria","perempuan","laki","silaturahim","daily","rutinitas","bahagia","sedih","cinta","emosi","keluarga","sosial","masalah","motivasi","inspirasi","tujuan","rencana","kebiasaan","jodoh","nikah"]},
    {name: "Kerja", k:["kerja","kantor","dokumen","strategi","pdf","psikotes","karir","bisnis","proyek","meeting","wawancara","resign","gaji","promosi","lembur","freelance","startup","cv","lamaran","manajemen","produktivitas"]},
    {name: "Kuliner", k:["resep","makan","minum","bumbu","kuliner","masak","restoran","kafe","jajanan","sarapan","makan siang","makan malam","diet","makanan","minuman","dapur","kue","roti","gorengan"]},
    {name: "Multimedia", k:["video","foto","audio","film","ffmpeg","imagemagick","photoshop","gimp","audacity","blender","premiere","davinci","lightroom","kdenlive","shotcut","editing","produksi","musik","podcast","vfx","efek"]},
    {name: "NixOS", k:["nixos","nix"]},
    {name: "OpenSUSE", k:["opensuse","suse","leap","tumbleweed","chameleon","zypper"]},
    {name: "OS Linux", k:["grub","oss","lts","open source","autoremove","cron","reinstall","dd","troubleshooting","skrip","rsync","systemd","sudo","backup","plugin","ssh","symlinks","mount","samba","linux","bootloader","distro","release","rilis","kernel","cli","shell","bash","zsh","init","pacman","yay","apt-get","dpkg","yum","dnf","zypper","aptitude","uname","ls","grep","awk","sed","chmod","chown","user","group","service","systemctl"]},
    {name: "OS Windows", k:["windows","windows 10","windows 11","powershell","cmd","registry","boot","update","explorer","task manager","bsod","driver"]},
    {name: "Redhat", k:["fedora","centos","redhat","rhel","scientific linux","alma","rocky","centos stream"]},
    {name: "Religi", k:["allah","shalat","sholat","agama","puasa","nabi","islam","madinah","religi","ghibah","muslim","quran","hadits","dakwah","doa","surga","neraka","masjid","iman","ibadah","hijab","akidah"]},
    {name: "Repository", k:["repository","dnf","apt","repo","snap","synaptic","octopi","flatpak","netselect","mirror","reflector","aur","ppa","github","gitlab","bitbucket","dockerhub","git","clone","push","pull"]},
    {name: "Slackware", k:["slackware","slac","sbopkg","pkgtools"]},
    {name: "Jaringan", k:["jaringan","internet","wifi","router","modem","ethernet","ip address","dns","firewall","tcp","udp","http","https","proxy","vpn","port","lan","wan","bandwidth","ping","traceroute"]},
    {name: "Pemrograman", k:["pemrograman","program","coding","javascript","python","php","java","c++","c","html","css","database","sql","mysql","mongodb","framework","library","api","bug","compiler","debugging","syntax","variabel","algoritma","frontend","backend","fullstack","data science"]},
    {name: "Perangkat Keras", k:["perangkat keras","hardware","cpu","gpu","ram","hardisk","ssd","motherboard","power supply","monitor","keyboard","mouse","printer","usb","driver","bios","uefi","processor","graphic card","storage","komponen"]},
    {name: "Keuangan", k:["keuangan","investasi","saham","crypto","bitcoin","uang","bank","tabungan","kredit","pinjaman","pajak","anggaran","ekonomi","fintech","reksadana","inflasi","utang"]}
  ];
  return (cats.find(c=>c.k.some(k=>t.includes(k)))||{name:"Lainnya"}).name;
}

// ----------------- Rate Limit Helper -----------------
async function checkRateLimit(){
  try{
    const res = await fetch('https://api.github.com/rate_limit');
    const data = await res.json();
    const remaining = data.rate.remaining;
    const resetTime = data.rate.reset * 1000;
    log(`üîπ GitHub API Remaining: ${remaining}, Reset at: ${new Date(resetTime).toLocaleTimeString()}`);
    return { remaining, resetTime };
  }catch(err){
    log("‚ùå Gagal cek rate limit: "+err.message);
    return { remaining:1, resetTime:Date.now()+60000 };
  }
}
async function fetchFileWithRateLimit(file){
  while(true){
    const { remaining, resetTime } = await checkRateLimit();
    if(remaining>5) break;
    const waitMs = resetTime - Date.now() + 1000;
    log(`‚è≥ Menunggu ${Math.ceil(waitMs/1000)}s karena rate limit hampir habis...`);
    await sleep(waitMs);
  }
  const text = await fetch(file.download_url).then(r=>r.text());
  return text;
}

// ----------------- Main -----------------
let totalFiles=0, completedFiles=0, startTimeProgress=0;
const categoryBars = {};

async function generateJSONRateLimitAware(){
  document.getElementById("jsonOutput").value="";
  document.getElementById("log").textContent="";
  document.getElementById("progressBarTotal").style.width="0%";
  document.getElementById("progressTextTotal").textContent="0 / 0 files | ETA: 0s";
  document.getElementById("categoryProgressContainer").innerHTML="";
  startTimeProgress=Date.now();
  completedFiles=0;

  try{
    log("üîç Mengambil daftar file dari repo...");
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${folder}`);
    const files = await res.json();
    const htmlFiles = files.filter(f=>f.type==="file" && f.name.endsWith(".html"));
    totalFiles = htmlFiles.length;
    log(`üìÇ Ditemukan ${totalFiles} file HTML`);

    const grouped = {};
    const seenTitles = new Set();
    const duplicates = [];

    // Adaptive concurrency
    let concurrency=10, batchSize=10, delayMs=50;
    if(totalFiles<=20){ concurrency=totalFiles; batchSize=totalFiles; delayMs=0; }
    else if(totalFiles<=100){ concurrency=10; batchSize=10; delayMs=50; }
    else if(totalFiles<=500){ concurrency=15; batchSize=15; delayMs=100; }
    else if(totalFiles<=2000){ concurrency=20; batchSize=20; delayMs=200; }
    else{ concurrency=25; batchSize=25; delayMs=300; }
    log(`‚ö° Concurrency: ${concurrency}, Batch size: ${batchSize}, Delay tiap batch: ${delayMs}ms`);

    let index=0;

    function createCategoryBar(cat){
      const container = document.getElementById("categoryProgressContainer");
      const wrapper = document.createElement("div");
      const barOuter = document.createElement("div");
      barOuter.className="categoryBarOuter";
      const barInner = document.createElement("div");
      barInner.className="categoryBarInner";
      barOuter.appendChild(barInner);
      const label = document.createElement("div");
      label.className="categoryLabel";
      label.textContent=`0 / 0`;
      wrapper.appendChild(barOuter);
      wrapper.appendChild(label);
      container.appendChild(wrapper);
      categoryBars[cat] = {bar: barInner, label: label, total:0, done:0};
    }

    function updateCategoryProgress(cat){
      const c = categoryBars[cat];
      if(!c) return;
      c.done++;
      const pct = Math.round((c.done/c.total)*100);
      c.bar.style.width = pct+"%";
      c.label.textContent = `${c.done} / ${c.total}`;
    }

    async function worker(){
      while(index<htmlFiles.length){
        const i=index++;
        const f=htmlFiles[i];
        try{
          const htmlText = await fetchFileWithRateLimit(f);
          const doc = new DOMParser().parseFromString(htmlText,'text/html');
          const title = doc.querySelector("title")?.innerText || f.name;
          const category = titleToCategory(title);
          if(!seenTitles.has(title)){
            seenTitles.add(title);
            if(!grouped[category]) grouped[category]=[];
            grouped[category].push([title,f.name]);
          } else { duplicates.push([title,f.name]); }

          // Category progress
          if(!categoryBars[category]) createCategoryBar(category);
          categoryBars[category].total = grouped[category].length;
          updateCategoryProgress(category);

        }catch(e){
          if(!grouped["Lainnya"]) grouped["Lainnya"]=[];
          grouped["Lainnya"].push([f.name,f.name]);
          if(!categoryBars["Lainnya"]) createCategoryBar("Lainnya");
          categoryBars["Lainnya"].total = grouped["Lainnya"].length;
          updateCategoryProgress("Lainnya");
        }

        // Total progress
        completedFiles++;
        const percent = Math.round((completedFiles/totalFiles)*100);
        document.getElementById("progressBarTotal").style.width = percent+"%";
        const elapsed = (Date.now()-startTimeProgress)/1000;
        const eta = Math.round((elapsed/completedFiles)*(totalFiles-completedFiles));
        document.getElementById("progressTextTotal").textContent = `${completedFiles} / ${totalFiles} files (${percent}%) | ETA: ${eta}s`;

        if((i+1)%batchSize===0 && delayMs>0) await sleep(delayMs);
      }
    }

    await Promise.all(Array(concurrency).fill().map(()=>worker()));

    function jsonPretty(obj){
      return '{\n'+Object.keys(obj).map(cat=>`  "${cat}":[\n${obj[cat].map(a=>`    ["${a[0]}","${a[1]}"]`).join(',\n')}\n  ]`).join(',\n')+'\n}';
    }
    document.getElementById("jsonOutput").value=jsonPretty(grouped);

    // Final log
    log("\nüìä Ringkasan per kategori:");
    Object.entries(grouped).sort((a,b)=>b[1].length-a[1].length).forEach(([cat,arr])=>log(`   - ${cat}: ${arr.length} item`));
    log(`\nüìà Total file: ${totalFiles}, Duplikat: ${duplicates.length}`);
    log(`‚è±Ô∏è Waktu total: ${(Date.now()-startTimeProgress)/1000}s`);
    if(duplicates.length){
      log("üìÇ Daftar duplikat:");
      duplicates.forEach(d=>log(`   ‚Ä¢ "${d[0]}" (${d[1]})`));
    }
    log("\n‚úÖ Proses selesai! JSON siap diunduh / dicopy.");

  }catch(err){ log("‚ùå Error: "+err.message); }
}

// ----------------- Buttons -----------------
document.getElementById("downloadBtn").addEventListener("click", ()=>{
  const blob = new Blob([document.getElementById("jsonOutput").value], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="artikel.json"; a.click(); URL.revokeObjectURL(url);
});
document.getElementById("copyBtn").addEventListener("click", async ()=>{
  try{ await navigator.clipboard.writeText(document.getElementById("jsonOutput").value); log("üìã JSON berhasil dicopy ke clipboard!"); }
  catch(err){ log("‚ùå Gagal copy JSON: "+err.message); }
});
document.getElementById("refreshBtn").addEventListener("click", ()=>{ generateJSONRateLimitAware(); });
document.getElementById("clearLogBtn").addEventListener("click", ()=>{ document.getElementById("log").textContent=""; });

// ----------------- Run -----------------
generateJSONRateLimitAware();
</script>

</body>
</html>
